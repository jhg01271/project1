name: CI

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v3

      # Get current UTC date for cache key
      - name: Get Date
        id: get-date
        run: echo "date=$(date -u +'%Y%m%d')" >> $GITHUB_ENV

      # Cache Buildozer global directory
      - name: Cache Buildozer global directory
        uses: actions/cache@v3
        with:
          path: .buildozer_global
          key: buildozer-global-${{ hashFiles('buildozer.spec') }} 
          restore-keys: |
            buildozer-global-

      # Cache Buildozer directory
      - name: Cache Buildozer directory
        uses: actions/cache@v3
        with:
          path: .buildozer
          key: ${{ runner.os }}-${{ env.date }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.date }}-
            ${{ runner.os }}-

      # Install latest Buildozer version
      - name: Install Buildozer
        run: pip install --upgrade buildozer

      # Download python-for-android if not exists
      - name: Check and Download python-for-android
        run: |
          if [ ! -d "/home/runner/work/project1/project1/.buildozer/android/platform/python-for-android" ]; then
            git clone https://github.com/kivy/python-for-android.git /home/runner/work/project1/project1/.buildozer/android/platform/python-for-android
          fi

      # Install Android NDK
      - name: Install Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip android-ndk-r25b-linux.zip
          export ANDROID_NDK_HOME=$PWD/android-ndk-r25b
          export PATH=$PATH:$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin

      # Install Android SDK
      - name: Install Android SDK
        run: |
          sudo apt-get install -y android-sdk
          export ANDROID_SDK_ROOT=/usr/lib/android-sdk
          export PATH=$PATH:$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/platform-tools

      # Install Cython (required for build)
      - name: Install Cython
        run: pip install Cython

      # Upgrade pip to the latest version
      - name: Upgrade pip
        run: pip install --upgrade pip

      # Clean and Build with Buildozer
      - name: Clean and Build with Buildozer
        run: |
          buildozer android clean
          buildozer android debug

      # Upload APK artifacts
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: apk
          path: ./bin/*.apk # Adjust according to actual build path
